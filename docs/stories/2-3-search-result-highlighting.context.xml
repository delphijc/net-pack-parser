<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>2</epicId>
    <storyId>3</storyId>
    <title>Search Result Highlighting</title>
    <status>drafted</status>
    <generatedAt>2025-11-29</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/2-3-search-result-highlighting.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>security analyst</asA>
    <iWant>search matches to be visually highlighted in packet details</iWant>
    <soThat>I can quickly see why a packet matched my search</soThat>
    <tasks>
- [ ] **1. Centralize Matching Logic**
  - [ ] Refactor `multiCriteriaSearch.ts` to expose granular matching functions (e.g., `getMatchRanges(packet, criteria)`) that return specific byte ranges or field names that matched.
  - [ ] Remove duplicated matching logic from `PacketDetailView.tsx` (addressing technical debt from Story 2.2).

- [ ] **2. Enhance PacketDetailView for Highlighting**
  - [ ] Update `PacketDetailView.tsx` to accept match ranges/metadata.
  - [ ] Implement highlighting for structured fields (IP, Port, Protocol).
  - [ ] Implement highlighting for Hex Dump view (byte ranges).
  - [ ] Implement highlighting for ASCII view (text ranges).
  - [ ] Ensure accessibility (use `<mark>` tags or `aria-label` for highlights).

- [ ] **3. Update PacketList for Visual Indication**
  - [ ] Add visual indicator (e.g., background color or icon) to rows in `PacketList.tsx` that match the current search.
  - [ ] Implement "Current Search" badge above the list.
  - [ ] Add Tooltip to badge showing full criteria details.

- [ ] **4. Testing**
  - [ ] Unit tests for `getMatchRanges` logic.
  - [ ] Component tests for `PacketDetailView` highlighting rendering.
  - [ ] Verify performance of highlighting on large payloads.
</tasks>
  </story>

  <acceptanceCriteria>
1.  **Given** I have performed a search with specific criteria
2.  **When** I view a packet from the search results
3.  **Then** all matching elements are highlighted with a yellow background (#FEF3C7):
    *   Matched IP addresses
    *   Matched port numbers
    *   Matched protocol name
    *   Matched strings in payload (in both hex dump and ASCII views)
4.  **And** when I view hex dump, matching bytes are highlighted in yellow
5.  **And** when I view ASCII representation, matching strings are highlighted
6.  **And** the search term appears in a "Current Search" badge above packet list
7.  **And** clicking the badge shows full search criteria in a tooltip
8.  **And** highlighting renders in < 100ms (per NFR-P4)
</acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/prd.md</path>
        <title>Product Requirements Document</title>
        <section>Packet Filtering & Search</section>
        <snippet>FR32: System highlights search matches in packet details view. NFR-P4: UI interactions must respond within 100ms.</snippet>
      </doc>
      <doc>
        <path>docs/stories/tech-spec-epic-2.md</path>
        <title>Epic Technical Specification</title>
        <section>Detailed Design</section>
        <snippet>AC-8: System highlights search matches in packet details view (packet list rows, hex dump, and ASCII representation). Highlights in yellow (#FEF3C7).</snippet>
      </doc>
      <doc>
        <path>docs/stories/2-2-multi-criteria-search.md</path>
        <title>Story 2.2: Multi-Criteria Search</title>
        <section>Learnings from Previous Story</section>
        <snippet>Code Duplication: PacketDetailView.tsx implements simplified matching logic that partially duplicates logic from multiCriteriaSearch.ts. Centralizing this logic would be cleaner.</snippet>
      </doc>
    </docs>
    <code>
      <file>
        <path>client/src/components/PacketDetailView.tsx</path>
        <kind>component</kind>
        <symbol>PacketDetailView</symbol>
        <reason>Main component to enhance with highlighting logic.</reason>
      </file>
      <file>
        <path>client/src/components/PacketList.tsx</path>
        <kind>component</kind>
        <symbol>PacketList</symbol>
        <reason>Needs visual indication for matching rows and "Current Search" badge.</reason>
      </file>
      <file>
        <path>client/src/utils/multiCriteriaSearch.ts</path>
        <kind>utility</kind>
        <symbol>multiCriteriaSearch</symbol>
        <reason>Refactor to expose granular matching ranges for highlighting.</reason>
      </file>
      <file>
        <path>client/src/types/packet.ts</path>
        <kind>interface</kind>
        <symbol>Packet</symbol>
        <reason>Core data structure.</reason>
      </file>
    </code>
    <dependencies>
      <pkg>react</pkg>
      <pkg>tailwindcss</pkg>
      <pkg>@shadcn/ui</pkg>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>Highlighting must render in < 100ms.</constraint>
    <constraint>Use CSS background-color #FEF3C7 (bg-yellow-200) for highlights.</constraint>
    <constraint>Ensure accessibility using mark tags or aria-labels.</constraint>
    <constraint>Centralize matching logic in utility functions, do not duplicate in components.</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>Packet</name>
      <kind>interface</kind>
      <path>client/src/types/packet.ts</path>
    </interface>
    <interface>
      <name>SearchCriteria</name>
      <kind>interface</kind>
      <path>client/src/utils/multiCriteriaSearch.ts</path>
    </interface>
  </interfaces>

  <tests>
    <standards>Use Vitest for unit tests and React Testing Library for component tests.</standards>
    <locations>client/src/utils/*.test.ts, client/src/components/*.test.tsx</locations>
    <ideas>
      <idea>Unit test getMatchRanges with various criteria to verify correct byte ranges are returned.</idea>
      <idea>Component test PacketDetailView to verify mark tags are rendered around matched text.</idea>
      <idea>Performance test highlighting with large packet payload.</idea>
    </ideas>
  </tests>
</story-context>
